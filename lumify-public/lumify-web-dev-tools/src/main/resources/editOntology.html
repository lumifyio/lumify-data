<html>
<head>
    <title>Lumify: Admin: Edit Ontology</title>
    <script src='/libs/jquery/jquery.js'></script>
    <script src='/libs/ejs/ejs.js'></script>
    <style type="text/css">
        label { display: block; font-weight: bold; margin-top: 5px; }
        input[type='submit'] { display: block; margin-top: 5px; }
    </style>
</head>
<body>

<form method="POST" action="/admin/saveOntologyConcept">
    <input type="hidden" name="csrfToken">

    <label for="concept">Concept:</label>
    <select name="concept" id="concept"></select>

    <label for="displayName">Display Name:</label>
    <input name="displayName" id="displayName" type="text" size="20" />

    <label for="color">Color:</label>
    <input name="color" id="color" type="text" size="20" />

    <label for="titleFormula">Title Formula:</label>
    <textarea name="titleFormula" id="titleFormula" type="text" cols="80" rows="4"></textarea>

    <label for="subtitleFormula">Subtitle Formula:</label>
    <textarea name="subtitleFormula" id="subtitleFormula" cols="80" rows="4"></textarea>

    <label for="timeFormula">Time Formula:</label>
    <textarea name="timeFormula" id="timeFormula" type="text" cols="80" rows="4"></textarea>

    <input type="submit" value="Save" disabled>
</form>

<script>
    $(function() {
        document.conceptTemplate = document.getElementById('conceptTemplate').innerHTML;

        $.get('/user/me')
            .fail(function() {
                alert('Not logged in or no token');
            })
            .done(function(user) {
                $('input[type=submit]').removeAttr('disabled');
                $('input[name=csrfToken]').val(user.csrfToken);
            });


        $.get('/ontology')
            .fail(function() {
                alert('Not logged in or no token');
            })
            .done(function(ontology) {
                console.log("ontology", ontology);
                document.ontology = ontology;
                var html = ejs.render(document.conceptTemplate, document.ontology);
                $('#concept').html(html);
                loadSelectedConcept();
            });

        $('#concept').change(loadSelectedConcept);

        function loadSelectedConcept() {
            $("#concept option:selected").each(function() {
                var conceptIRI = $(this).val(),
                        concept = findConceptByIRI(conceptIRI);

                console.log("concept", concept);
                $('#displayName').val(concept.displayName);
                $('#color').val(concept.color);
                $('#titleFormula').val(concept.titleFormula);
                $('#subtitleFormula').val(concept.subtitleFormula);
                $('#timeFormula').val(concept.timeFormula);
            });
        }

        function findConceptByIRI(conceptIRI) {
            return document.ontology.concepts.filter(function(concept) {
                return concept.id == conceptIRI;
            })[0];
        }
    });
</script>

<script id="conceptTemplate" type="text/template">
    <% concepts.forEach(function(concept) { %>
    <option value="<%= concept.id %>"><%= concept.displayName %> (<%= concept.id %>)</option>
    <% }) %>
</script>

</body>
</html>